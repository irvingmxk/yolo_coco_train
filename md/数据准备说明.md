# 数据准备说明

## 📁 数据集结构

### 原始数据格式

数据集应该按照以下结构组织：

```
data_1029/
├── images/                 # 所有图片
│   ├── image1.jpg
│   ├── image2.jpg
│   └── ...
├── labels/                 # YOLO格式标注
│   ├── image1.txt
│   ├── image2.txt
│   └── ...
└── classes.txt            # 类别列表（每行一个类别）
```

### 准备后的结构

运行数据准备脚本后，会自动生成：

```
data_1029/
├── images/                 # 原始图片（保留）
├── labels/                 # 原始标签（保留）
├── classes.txt            # 类别列表（保留）
├── train/                 # 训练集（新增）
│   ├── images/
│   │   ├── train_img1.jpg
│   │   └── ...
│   └── labels/
│       ├── train_img1.txt
│       └── ...
├── val/                   # 验证集（新增）
│   ├── images/
│   │   ├── val_img1.jpg
│   │   └── ...
│   └── labels/
│       ├── val_img1.txt
│       └── ...
└── data.yaml              # YOLO配置文件（新增）
```

## 🚀 使用方法

### 方法1：默认配置（推荐）

直接运行脚本，使用默认配置：

```bash
cd /workspace/yolo
python prepare_data.py
```

默认配置：
- 数据路径: `/workspace/yolo/data_1029`
- 验证集比例: 20%
- 随机种子: 42

### 方法2：自定义配置

使用命令行参数自定义配置：

```bash
# 指定数据路径
python prepare_data.py --data /workspace/yolo/your_data

# 自定义验证集比例（例如30%）
python prepare_data.py --val-split 0.3

# 设置随机种子
python prepare_data.py --seed 123

# 强制重新分割（不询问）
python prepare_data.py --force

# 组合使用
python prepare_data.py --data /workspace/yolo/data_1029 --val-split 0.2 --seed 42 --force
```

### 参数说明

| 参数 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `--data` | string | `/workspace/yolo/data_1029` | 数据目录路径 |
| `--val-split` | float | `0.2` | 验证集比例（0.0-1.0）|
| `--seed` | int | `42` | 随机种子（确保可重复性）|
| `--force` | flag | `False` | 强制重新分割，不询问 |

## 📊 当前数据集信息

### data_1029 数据集

- **总图片数**: 158 张
- **类别数**: 3 个
  - 0: bubble（气泡）
  - 1: other（其他）
  - 2: user（用户）
- **训练集**: 127 张 (80%)
- **验证集**: 31 张 (20%)
- **数据质量**: ✅ 所有图片都有对应标签

## ⚙️ 训练脚本配置

所有训练脚本已自动配置使用 `data_1029` 数据集：

### 已配置的文件

| 文件 | 模型 | Batch | 数据路径 |
|------|------|-------|---------|
| `train_yolo11n.py` | YOLO11n | 16 | `/workspace/yolo/data_1029` |
| `train_yolo11s.py` | YOLO11s | 16 | `/workspace/yolo/data_1029` |
| `train_yolo11m.py` | YOLO11m | 8 | `/workspace/yolo/data_1029` |
| `train_yolov8s.py` | YOLOv8s | 16 | `/workspace/yolo/data_1029` |

### 训练命令

准备数据后，可以直接开始训练：

```bash
# 使用YOLO11n (最快，推荐先测试)
python train_yolo11n.py

# 使用YOLO11s (平衡速度和精度)
python train_yolo11s.py

# 使用YOLO11m (更高精度)
python train_yolo11m.py

# 使用YOLOv8s (经典模型)
python train_yolov8s.py
```

## 🔄 重新准备数据

如果需要重新划分数据集（例如改变验证集比例）：

### 交互式重新分割

```bash
python prepare_data.py
# 会提示：是否重新分割? (y/n)
```

### 强制重新分割（不询问）

```bash
python prepare_data.py --force
```

### 改变验证集比例

```bash
# 使用30%作为验证集
python prepare_data.py --val-split 0.3 --force

# 使用10%作为验证集
python prepare_data.py --val-split 0.1 --force
```

## 📋 data.yaml 配置文件

脚本会自动生成 `data.yaml` 文件，内容如下：

```yaml
path: /workspace/yolo/data_1029
train: train/images
val: val/images
nc: 3
names:
  - bubble
  - other
  - user
```

## ✅ 数据质量检查

脚本会自动检查：

1. **图片和标签匹配**: 确保每张图片都有对应的标签文件
2. **空标签检测**: 检查是否有空的标注文件
3. **统计信息**: 显示平均每张图片的目标数量

### 示例输出

```
数据质量检查
============================================================

TRAIN:
  图片数量: 127
  标签数量: 127
  ✅ 图片和标签数量匹配
  ✅ 无空标签文件
  📊 平均每张图片: 3.45 个目标

VAL:
  图片数量: 31
  标签数量: 31
  ✅ 图片和标签数量匹配
  ✅ 无空标签文件
  📊 平均每张图片: 3.52 个目标
```

## ⚠️ 常见问题

### 1. 数据已分割但想改变比例

```bash
python prepare_data.py --val-split 0.3 --force
```

### 2. 图片和标签数量不匹配

检查 `images/` 和 `labels/` 目录，确保：
- 每个图片文件都有对应的标签文件
- 文件名完全相同（只有扩展名不同）

### 3. 没有 classes.txt 文件

创建 `classes.txt` 文件，每行一个类别名称：

```bash
cd /workspace/yolo/data_1029
cat > classes.txt << EOF
bubble
other
user
EOF
```

### 4. 使用其他数据集

```bash
# 准备其他数据集
python prepare_data.py --data /path/to/your/dataset

# 然后修改训练脚本中的数据路径
# 编辑 train_yolo11n.py 等文件
# 将 data_dir = Path('/workspace/yolo/data_1029') 
# 改为 data_dir = Path('/path/to/your/dataset')
```

## 🎯 最佳实践

### 1. 验证集比例建议

- **小数据集** (<100张): 20-30%
- **中等数据集** (100-1000张): 15-20%
- **大数据集** (>1000张): 10-15%

### 2. 随机种子

使用固定的随机种子（如42）可以确保：
- 每次分割结果相同
- 便于对比不同模型的效果
- 便于复现实验结果

### 3. 数据检查

在训练前，务必：
1. 运行数据准备脚本
2. 检查输出的统计信息
3. 随机查看几张图片的标注是否正确

## 📝 完整流程示例

```bash
# 1. 准备数据
cd /workspace/yolo
python prepare_data.py --data /workspace/yolo/data_1029 --val-split 0.2

# 2. 检查输出
# 查看是否有错误或警告信息

# 3. 开始训练（选择一个模型）
python train_yolo11n.py

# 4. 如果需要重新准备数据
python prepare_data.py --force --val-split 0.3
```

## 🔧 脚本功能

`prepare_data.py` 提供的功能：

- ✅ 自动划分训练集和验证集
- ✅ 复制图片和标签文件到对应目录
- ✅ 生成YOLO配置文件 (data.yaml)
- ✅ 数据质量检查
- ✅ 支持自定义参数
- ✅ 交互式确认（可选）
- ✅ 详细的统计信息

---

**准备好数据后，就可以开始训练了！** 🚀

```bash
python train_yolo11n.py  # 推荐先用最快的模型测试
```

